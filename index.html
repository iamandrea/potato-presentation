<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Obsession: Potatoes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/TextPlugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0a;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* ---- Slides ---- */
    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 80px;
      visibility: hidden;
      z-index: 0;
    }
    .slide.active {
      visibility: visible;
      z-index: 10;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 4.5rem;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      line-height: 1.15;
    }
    h2 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 28px;
      text-align: center;
      line-height: 1.2;
    }
    p, .body-text {
      font-size: 1.45rem;
      line-height: 1.7;
      text-align: center;
      max-width: 780px;
    }
    ul {
      font-size: 1.35rem;
      line-height: 2;
      list-style: none;
      padding: 0;
    }
    ul li { padding: 4px 0; }
    ul li::before { content: ''; }

    .subtitle {
      font-size: 1.15rem;
      opacity: 0.6;
      margin-top: 14px;
      letter-spacing: 0.05em;
    }
    .emoji { font-size: 5rem; margin-bottom: 16px; }
    .big-emoji { font-size: 9rem; margin-bottom: 20px; }
    .highlight { color: #f0b429; }
    .italic { font-style: italic; }
    .dim { opacity: 0.55; }
    .small { font-size: 1.1rem; opacity: 0.7; margin-top: 20px; }

    /* ---- Floating potato particles ---- */
    .potato-particle {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      z-index: 0;
      opacity: 0;
    }

    /* ---- Progress bar ---- */
    .progress {
      position: fixed;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #f0b429, #e8a838);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 200;
    }

    /* ---- Slide counter ---- */
    .counter {
      position: fixed;
      bottom: 16px;
      right: 28px;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.3);
      z-index: 200;
      user-select: none;
      font-family: 'Space Grotesk', sans-serif;
    }

    /* ---- Theme per slide ---- */
    .slide[data-theme="dark"]   { background: #0a0a0a; color: #f5f0e8; }
    .slide[data-theme="gold"]   { background: linear-gradient(135deg, #c9984d, #8B6914); color: #fff; }
    .slide[data-theme="warm"]   { background: #fdf6e3; color: #2c1810; }
    .slide[data-theme="deep"]   { background: #1a0f0a; color: #f5e6d0; }
    .slide[data-theme="ember"]  { background: linear-gradient(135deg, #d4761e, #a0522d); color: #fff; }
    .slide[data-theme="cream"]  { background: #faf3e0; color: #3e2723; }
    .slide[data-theme="night"]  { background: #0d0d0d; color: #f5f0e8; }
    .slide[data-theme="sunset"] { background: linear-gradient(135deg, #e8a838, #c9652e); color: #fff; }
    .slide[data-theme="brown"]  { background: #2c1810; color: #fdf6e3; }
    .slide[data-theme="lemon"]  { background: linear-gradient(135deg, #f7dc6f, #d4e157); color: #2c1810; }
    .slide[data-theme="final"]  { background: #0a0a0a; color: #f5f0e8; }

    /* ---- Tier list ---- */
    .tier-row {
      display: flex;
      align-items: center;
      margin: 10px 0;
      border-radius: 10px;
      overflow: hidden;
      width: 700px;
      max-width: 90vw;
    }
    .tier-label {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      width: 80px;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .tier-items {
      flex: 1;
      padding: 14px 24px;
      font-size: 1.2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .tier-item {
      background: rgba(255,255,255,0.15);
      padding: 6px 16px;
      border-radius: 20px;
      white-space: nowrap;
    }
    .tier-a .tier-label { background: #f0b429; color: #2c1810; }
    .tier-a .tier-items { background: rgba(240,180,41,0.15); }
    .tier-b .tier-label { background: #e8a838; color: #2c1810; }
    .tier-b .tier-items { background: rgba(232,168,56,0.12); }
    .tier-c .tier-label { background: #8B6914; color: #fff; }
    .tier-c .tier-items { background: rgba(139,105,20,0.15); }

    /* ---- Nutrition grid ---- */
    .nutrition-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
      max-width: 700px;
    }
    .nutrition-card {
      background: rgba(240,180,41,0.1);
      border: 1px solid rgba(240,180,41,0.2);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }
    .nutrition-card .value {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      color: #f0b429;
    }
    .nutrition-card .label {
      font-size: 0.95rem;
      opacity: 0.7;
      margin-top: 4px;
    }

    /* ---- Glow text ---- */
    .glow {
      text-shadow: 0 0 40px rgba(240,180,41,0.4), 0 0 80px rgba(240,180,41,0.15);
    }

    /* ---- Age badge ---- */
    .age-badge {
      font-family: 'Playfair Display', serif;
      font-size: 6rem;
      font-weight: 700;
      opacity: 0.1;
      position: absolute;
      top: 40px;
      right: 60px;
    }

    /* ---- Chapter label ---- */
    .chapter {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.25em;
      opacity: 0.4;
      margin-bottom: 20px;
    }

    /* ---- Quote style ---- */
    .quote {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 2rem;
      line-height: 1.5;
      max-width: 700px;
      text-align: center;
    }
    .quote-attr {
      font-size: 1rem;
      opacity: 0.5;
      margin-top: 16px;
    }

    /* ---- Animated background shapes ---- */
    .bg-shape {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      filter: blur(80px);
      opacity: 0.15;
    }

    /* ---- Slide images ---- */
    .slide-img {
      max-width: 340px;
      max-height: 260px;
      border-radius: 16px;
      object-fit: contain;
      margin: 20px 0;
      filter: drop-shadow(0 8px 30px rgba(0,0,0,0.4));
    }
    .slide-img.restaurant {
      max-width: 400px;
      max-height: 280px;
      border-radius: 14px;
      object-fit: cover;
    }
    .slide-img.superfries-reveal {
      max-width: 500px;
      max-height: 340px;
    }

    /* ---- QR code ---- */
    #qr-container {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      display: inline-block;
    }
    #qr-container img, #qr-container canvas {
      display: block;
    }

    /* ---- Vote results bars ---- */
    .results-container {
      width: 650px;
      max-width: 90vw;
    }
    .result-row {
      display: flex;
      align-items: center;
      margin: 8px 0;
      gap: 14px;
    }
    .result-label {
      width: 130px;
      text-align: right;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .result-bar-bg {
      flex: 1;
      height: 38px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .result-bar {
      height: 100%;
      background: linear-gradient(90deg, #f0b429, #e8a838);
      border-radius: 8px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 0;
    }
    .result-count {
      width: 40px;
      font-size: 1.1rem;
      font-weight: 700;
      color: #f0b429;
    }
    .vote-total {
      font-size: 1rem;
      opacity: 0.5;
      margin-top: 16px;
      text-align: center;
    }

    /* ---- Correct answer green highlight ---- */
    .result-row.top3 .result-bar {
      background: linear-gradient(90deg, #2ecc71, #27ae60) !important;
    }
    .result-row.top3 .result-count {
      color: #2ecc71 !important;
    }
    .result-row.top3 .result-label {
      font-weight: 700 !important;
    }

    /* ---- Emoji rain ---- */
    .emoji-rain {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .rain-drop {
      position: absolute;
      top: -60px;
      font-size: 2rem;
      opacity: 0;
      pointer-events: none;
      will-change: transform;
    }
  </style>
</head>
<body>

  <!-- Floating potato particles -->
  <div id="particles"></div>

  <!-- ======== SLIDES ======== -->

  <!-- 1: TITLE -->
  <div class="slide active" data-theme="dark" id="slide-title">
    <div class="emoji-rain" id="emoji-rain"></div>
    <div class="big-emoji anim-item">&#x1F954;</div>
    <h1 class="anim-item glow">My Obsession: Potatoes</h1>
    <p class="subtitle anim-item">A deeply personal journey</p>
  </div>

  <!-- 2: THE ORIGIN - CLIFFHANGER -->
  <div class="slide" data-theme="deep">
    <div class="age-badge anim-item">4-13</div>
    <div class="chapter anim-item">The Origin Story</div>
    <h2 class="anim-item">Every night.<br>For ten years.</h2>
    <p class="anim-item">From age 4 to 13, I ate the same thing for dinner.</p>
    <p class="anim-item" style="margin-top: 28px; font-size: 2.2rem;">
      <strong class="highlight">My drug of choice?</strong>
    </p>
  </div>

  <!-- 3: THE REVEAL -->
  <div class="slide" data-theme="deep" id="slide-reveal">
    <img src="superfries.png" alt="McCain SuperFries Shoestring" class="slide-img superfries-reveal" id="superfries-img">
    <h2 class="anim-item" style="margin-top: 16px;">McCain's Shoestring SuperFries.</h2>
    <p class="anim-item small">Not sometimes. Not often. Every. Single. Night.</p>
  </div>

  <!-- 3: COMING OF AGE -->
  <div class="slide" data-theme="ember">
    <div class="age-badge anim-item" style="opacity:0.08; color:#fff;">15</div>
    <div class="chapter anim-item">Coming of Age</div>
    <h2 class="anim-item">The obsession goes public</h2>
    <p class="anim-item">At 15 I started going out to restaurants with friends.<br>
    Everyone's ordering burgers, pasta, salads...</p>
    <p class="anim-item" style="margin-top:20px; font-size:1.8rem;"><strong>I ordered a bowl of hot chips.</strong></p>
    <p class="anim-item small">My friends correctly assumed there was something wrong with me.</p>
  </div>

  <!-- 4: THE WHITEHOUSE -->
  <div class="slide" data-theme="warm">
    <div class="chapter anim-item">Notable Chips</div>
    <div class="age-badge anim-item" style="opacity:0.08;">19</div>
    <h2 class="anim-item">The Whitehouse, UNSW</h2>
    <img src="chips-restaurant.png" alt="The chips in question" class="slide-img restaurant anim-item">
    <p class="anim-item">One day I went to lunch with Scott.</p>
    <p class="anim-item" style="margin-top:16px;">We both ordered <strong class="highlight">a bowl of hot chips</strong> for lunch.</p>
    <p class="anim-item" style="margin-top:20px; font-size:1.6rem; font-style:italic;">"That's how I knew we'd be friends forever." - Me</p>
  </div>

  <!-- 5: THE DEFENCE -->
  <div class="slide" data-theme="night">
    <div class="chapter anim-item">The Defence</div>
    <h2 class="anim-item">"Isn't that just carbs?"</h2>
    <p class="anim-item" style="margin-bottom: 16px;">Glad you asked. Per medium potato:</p>
    <div class="nutrition-grid anim-item" style="grid-template-columns: repeat(2, 1fr); max-width: 420px;">
      <div class="nutrition-card">
        <div class="value">4g</div>
        <div class="label">Fibre</div>
      </div>
      <div class="nutrition-card">
        <div class="value">620mg</div>
        <div class="label">Potassium</div>
      </div>
    </div>
    <p class="anim-item" style="font-size: 1.1rem; opacity: 0.5; margin-top: 20px; line-height: 1.9;">
      28% Vitamin C &middot; 27% Vitamin B6 &middot; 10% Iron &middot; 3g Protein
    </p>
    <p class="anim-item small">More potassium than a banana. You're welcome.</p>
  </div>

  <!-- VOTE: QR CODE -->
  <div class="slide" data-theme="gold" id="slide-qr">
    <div class="chapter anim-item">Audience Participation</div>
    <h2 class="anim-item">What's the best potato?</h2>
    <div id="qr-container" class="anim-item"></div>
    <p class="anim-item" style="font-size: 1.2rem; margin-top: 8px;">Scan to vote. You have one shot.</p>
    <p class="anim-item small" id="vote-count-qr">Waiting for votes...</p>
  </div>

  <!-- VOTE: LIVE RESULTS -->
  <div class="slide" data-theme="night" id="slide-results">
    <div class="chapter anim-item">The People Have Spoken</div>
    <h2 class="anim-item">Your Votes</h2>
    <div class="results-container anim-item" id="results-bars"></div>
    <p class="vote-total anim-item" id="vote-total"></p>
  </div>

  <!-- TIER LIST (THE CORRECT ANSWER) — same bar layout as results -->
  <div class="slide" data-theme="brown" id="slide-correct">
    <div class="chapter anim-item">The Correct Answer</div>
    <h2 class="anim-item">The <em>Real</em> Ranking</h2>
    <div class="results-container anim-item" id="correct-bars"></div>
    <p class="anim-item small">This ranking is final. No appeals.</p>
  </div>

  <!-- HOTEL BONDI -->
  <div class="slide" data-theme="warm">
    <div class="chapter anim-item">Notable Chips</div>
    <div class="age-badge anim-item" style="opacity:0.08;">33</div>
    <h2 class="anim-item">Hotel Bondi</h2>
    <img src="hotel-bondi-chips.jpg" alt="Hotel Bondi chips" class="slide-img restaurant anim-item">
    <p class="anim-item" style="margin-top: 16px;">Highly recommend their chips.</p>
  </div>

  <!-- THE EVOLUTION -->
  <div class="slide" data-theme="sunset">
    <div class="chapter anim-item">The Evolution</div>
    <h2 class="anim-item">That brings us to now</h2>
    <p class="anim-item">These days I make roast potatoes almost every night and I am pushing my obsession onto my husband.</p>
  </div>

  <!-- 8: THE WEBER -->
  <div class="slide" data-theme="dark">
    <div class="chapter anim-item">The New Chapter</div>
    <div class="emoji anim-item">&#x1F525;</div>
    <h2 class="anim-item glow">The Weber Method</h2>
    <img src="weber-potatoes.jpg" alt="Weber roasted potatoes" class="slide-img restaurant anim-item">
    <p class="anim-item">Cubed potatoes in a cast iron casserole pan for 30min with olive oil, salt, pepper and a splash of water.</p>
    <p class="anim-item" style="margin-top: 16px;">And then...</p>
    <p class="anim-item" style="font-size: 2.2rem; margin-top: 12px;">
      <strong class="highlight">&#x1F34B; Fresh lemon squeezed on top.</strong>
    </p>
    <p class="anim-item small" style="margin-top: 24px;">Lemon is my second obsession. But that's a presentation for another party.</p>
  </div>

  <!-- CLOSING -->
  <div class="slide" data-theme="final">
    <div class="big-emoji anim-item">&#x1F954;</div>
    <h1 class="anim-item glow">Thank You</h1>
    <p class="anim-item" style="font-size:1.6rem;">I will not be taking questions.<br>Only hot chips.</p>
    <div class="bg-shape" style="width:400px;height:400px;background:#f0b429;bottom:-100px;left:-100px;"></div>
    <div class="bg-shape" style="width:300px;height:300px;background:#d4761e;top:-80px;right:-60px;"></div>
  </div>

  <!-- ======== END SLIDES ======== -->

  <div class="progress"></div>
  <div class="counter"></div>

  <script>
    gsap.registerPlugin(TextPlugin);

    const slides = document.querySelectorAll('.slide');
    const progress = document.querySelector('.progress');
    const counter = document.querySelector('.counter');
    let current = 0;
    let animating = false;

    // ---- Floating potato particles ----
    const particleContainer = document.getElementById('particles');
    const emojis = ['\u{1F954}', '\u{1F35F}', '\u{1F34B}'];
    for (let i = 0; i < 15; i++) {
      const el = document.createElement('div');
      el.className = 'potato-particle';
      el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = Math.random() * 100 + 'vh';
      el.style.fontSize = (1.2 + Math.random() * 1.5) + 'rem';
      particleContainer.appendChild(el);

      gsap.to(el, {
        y: -80 + Math.random() * 160,
        x: -40 + Math.random() * 80,
        opacity: 0.12 + Math.random() * 0.12,
        rotation: Math.random() * 360,
        duration: 6 + Math.random() * 8,
        repeat: -1,
        yoyo: true,
        ease: 'sine.inOut',
        delay: Math.random() * 4,
      });
    }

    // ---- Initial slide entrance ----
    function animateFirstSlide(slideEl) {
      const items = slideEl.querySelectorAll('.anim-item');
      const tl = gsap.timeline();
      tl.fromTo(slideEl, { opacity: 0 }, { opacity: 1, duration: 0.4, ease: 'power2.out' }, 0);
      items.forEach((item, i) => {
        tl.fromTo(item,
          { opacity: 0, y: 40, scale: 0.97 },
          { opacity: 1, y: 0, scale: 1, duration: 0.55, ease: 'power3.out' },
          0.1 + i * 0.1
        );
      });
      return tl;
    }

    // ---- Navigate ----
    function goTo(index, direction) {
      if (index < 0 || index >= slides.length || index === current || animating) return;
      animating = true;

      const outSlide = slides[current];
      const inSlide = slides[index];

      // Kill any running tweens on both slides
      gsap.killTweensOf(outSlide.querySelectorAll('.anim-item'));
      gsap.killTweensOf(outSlide);
      gsap.killTweensOf(inSlide.querySelectorAll('.anim-item'));
      gsap.killTweensOf(inSlide);

      const master = gsap.timeline({
        onComplete: () => { animating = false; }
      });

      // Exit current slide — fast
      const xTo = direction === 1 ? -30 : 30;
      const outItems = outSlide.querySelectorAll('.anim-item');
      outItems.forEach((item, i) => {
        master.to(item, { opacity: 0, x: xTo * 0.3, duration: 0.12, ease: 'power2.in' }, i * 0.01);
      });
      master.to(outSlide, { opacity: 0, duration: 0.1, ease: 'power2.in' }, 0.03);

      // Swap active class
      master.call(() => {
        outSlide.classList.remove('active');
        inSlide.classList.add('active');
        current = index;
        progress.style.width = ((current + 1) / slides.length * 100) + '%';
        counter.textContent = (current + 1) + ' / ' + slides.length;
      });

      // Enter new slide — fast
      const xFrom = direction === 1 ? 40 : -40;
      const inItems = inSlide.querySelectorAll('.anim-item');
      const enterStart = master.duration();
      master.fromTo(inSlide, { opacity: 0 }, { opacity: 1, duration: 0.2, ease: 'power2.out' }, enterStart);
      inItems.forEach((item, i) => {
        master.fromTo(item,
          { opacity: 0, y: 20, x: xFrom * 0.2, scale: 0.98 },
          { opacity: 1, y: 0, x: 0, scale: 1, duration: 0.3, ease: 'power3.out' },
          enterStart + 0.05 + i * 0.05
        );
      });

      const shapes = inSlide.querySelectorAll('.bg-shape');
      shapes.forEach((shape, i) => {
        master.fromTo(shape,
          { scale: 0.5, opacity: 0 },
          { scale: 1, opacity: 0.15, duration: 1, ease: 'power2.out' },
          enterStart + 0.15 + i * 0.1
        );
      });
    }

    // ---- Keyboard ----
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
        e.preventDefault();
        goTo(current + 1, 1);
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        goTo(current - 1, -1);
      } else if (e.key === 'Home') {
        e.preventDefault();
        goTo(0, -1);
      } else if (e.key === 'End') {
        e.preventDefault();
        goTo(slides.length - 1, 1);
      } else if (e.key === 'r' || e.key === 'R') {
        // Reset all votes
        if (confirm('Reset all votes?')) {
          fetch('/api/reset', { method: 'POST' });
        }
      }
    });

    // ---- Click navigation ----
    document.addEventListener('click', (e) => {
      if (e.clientX > window.innerWidth / 2) {
        goTo(current + 1, 1);
      } else {
        goTo(current - 1, -1);
      }
    });

    // ---- Touch/swipe support ----
    let touchStartX = 0;
    document.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });
    document.addEventListener('touchend', (e) => {
      const diff = touchStartX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) goTo(current + 1, 1);
        else goTo(current - 1, -1);
      }
    });

    // ---- SuperFries bounce-in on reveal slide ----
    const revealSlide = document.getElementById('slide-reveal');
    const superfriesImg = document.getElementById('superfries-img');

    // Override the standard enter for the reveal slide
    const originalGoTo = goTo;

    // We need to hook into the slide transition to add the bounce
    // Watch for when the reveal slide becomes active
    const observer = new MutationObserver(() => {
      if (revealSlide.classList.contains('active') && superfriesImg) {
        // The image starts hidden, then bounces in
        gsap.fromTo(superfriesImg,
          { scale: 0, rotation: -15, opacity: 0, y: -100 },
          {
            scale: 1, rotation: 0, opacity: 1, y: 0,
            duration: 0.8,
            ease: 'bounce.out',
            delay: 0.15,
          }
        );
      }
    });
    observer.observe(revealSlide, { attributes: true, attributeFilter: ['class'] });

    // ---- QR Code generation ----
    async function generateQR() {
      const container = document.getElementById('qr-container');
      if (container.hasChildNodes()) return;
      try {
        const res = await fetch('/api/vote-url');
        const { url: voteUrl } = await res.json();
        new QRCode(container, {
          text: voteUrl,
          width: 220,
          height: 220,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {
        container.innerHTML = '<p style="color:#333;padding:20px;">Start with: node server.js</p>';
      }
    }

    // Generate QR when QR slide becomes visible
    const qrSlide = document.getElementById('slide-qr');
    const qrObserver = new MutationObserver(() => {
      if (qrSlide.classList.contains('active')) generateQR();
    });
    qrObserver.observe(qrSlide, { attributes: true, attributeFilter: ['class'] });

    // ---- SSE: Live vote results ----
    const VOTE_OPTIONS = ['Hot Chips', 'BBQ Roasted', 'Potato Salad', 'Oven Baked', 'Air Fried', 'Mashed', 'Boiled'];
    let latestVotes = {};
    let totalVoters = 0;

    function connectSSE() {
      const es = new EventSource('/api/results');
      es.onmessage = (e) => {
        const data = JSON.parse(e.data);
        latestVotes = data.votes || {};
        totalVoters = data.totalVoters || 0;
        updateVoteCountDisplay();
        updateResultsBars();
      };
      es.onerror = () => {
        // Silently retry - SSE auto-reconnects
      };
    }

    function updateVoteCountDisplay() {
      const el = document.getElementById('vote-count-qr');
      if (el) {
        el.textContent = totalVoters === 0
          ? 'Waiting for votes...'
          : `${totalVoters} vote${totalVoters !== 1 ? 's' : ''} so far`;
      }
    }

    function updateResultsBars() {
      const container = document.getElementById('results-bars');
      const totalEl = document.getElementById('vote-total');
      if (!container) return;

      const maxVotes = Math.max(1, ...VOTE_OPTIONS.map(o => latestVotes[o] || 0));

      // Build or update bars
      if (!container.hasChildNodes()) {
        VOTE_OPTIONS.forEach(opt => {
          const row = document.createElement('div');
          row.className = 'result-row';
          row.dataset.option = opt;
          row.innerHTML = `
            <div class="result-label">${opt}</div>
            <div class="result-bar-bg"><div class="result-bar" style="width:0%"></div></div>
            <div class="result-count">0</div>
          `;
          container.appendChild(row);
        });
      }

      VOTE_OPTIONS.forEach(opt => {
        const row = container.querySelector(`[data-option="${opt}"]`);
        if (!row) return;
        const count = latestVotes[opt] || 0;
        const pct = (count / maxVotes) * 100;
        row.querySelector('.result-bar').style.width = pct + '%';
        row.querySelector('.result-count').textContent = count;
      });

      if (totalEl) {
        totalEl.textContent = totalVoters === 0
          ? 'No votes yet'
          : `${totalVoters} total vote${totalVoters !== 1 ? 's' : ''}`;
      }
    }

    // ---- Correct answer bar chart with shuffle animation ----
    const CORRECT_RANKING = [
      { label: 'Hot Chips', score: 100, top: true },
      { label: 'BBQ Roasted', score: 90, top: true },
      { label: 'Potato Salad', score: 65, top: true },
      { label: 'Oven Baked', score: 55, top: false },
      { label: 'Air Fried', score: 50, top: false },
      { label: 'Mashed', score: 20, top: false },
      { label: 'Boiled', score: 10, top: false },
    ];

    let correctAnimRan = false;

    function buildCorrectBars() {
      const container = document.getElementById('correct-bars');
      if (container.hasChildNodes()) return;

      // Start in a shuffled order
      const shuffled = [...CORRECT_RANKING].sort(() => Math.random() - 0.5);
      shuffled.forEach(item => {
        const row = document.createElement('div');
        row.className = 'result-row';
        row.dataset.option = item.label;
        row.innerHTML = `
          <div class="result-label">${item.label}</div>
          <div class="result-bar-bg"><div class="result-bar" style="width:50%"></div></div>
          <div class="result-count" style="width:auto;min-width:30px;opacity:0">★</div>
        `;
        container.appendChild(row);
      });
    }

    function animateCorrectBars() {
      if (correctAnimRan) return;
      correctAnimRan = true;

      const container = document.getElementById('correct-bars');
      const rows = Array.from(container.querySelectorAll('.result-row'));
      const ROW_HEIGHT = rows[0].offsetHeight + 8; // height + margin

      // Phase 1: Shuffle around for suspense (swap random pairs)
      const tl = gsap.timeline();
      const shuffleCount = 6;

      for (let s = 0; s < shuffleCount; s++) {
        const i = Math.floor(Math.random() * rows.length);
        let j = Math.floor(Math.random() * rows.length);
        while (j === i) j = Math.floor(Math.random() * rows.length);

        const rowI = rows[i];
        const rowJ = rows[j];
        const dy = (j - i) * ROW_HEIGHT;

        tl.to(rowI, { y: '+=' + dy, duration: 0.25, ease: 'power2.inOut' }, 0.35 * s);
        tl.to(rowJ, { y: '-=' + dy, duration: 0.25, ease: 'power2.inOut' }, 0.35 * s);

        // Update the tracking array
        [rows[i], rows[j]] = [rows[j], rows[i]];
      }

      // Phase 2: After shuffling, snap everything back to origin and reorder DOM
      tl.call(() => {
        // Reset all transforms
        container.querySelectorAll('.result-row').forEach(r => gsap.set(r, { y: 0 }));

        // Reorder DOM to correct ranking
        CORRECT_RANKING.forEach(item => {
          const row = container.querySelector(`[data-option="${item.label}"]`);
          container.appendChild(row);
        });
      });

      // Phase 3: Animate bars to correct widths with stagger
      tl.call(() => {
        CORRECT_RANKING.forEach((item, i) => {
          const row = container.querySelector(`[data-option="${item.label}"]`);
          const bar = row.querySelector('.result-bar');
          const star = row.querySelector('.result-count');

          gsap.to(bar, {
            width: item.score + '%',
            duration: 0.5,
            delay: i * 0.08,
            ease: 'power2.out',
          });

          if (item.top) {
            gsap.delayedCall(0.8 + i * 0.08, () => {
              bar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
              row.classList.add('top3');
            });
            gsap.to(star, { opacity: 1, scale: 1.3, delay: 0.9 + i * 0.08, duration: 0.3, ease: 'back.out(2)' });
          } else {
            gsap.set(star, { opacity: 0 });
          }
        });
      }, null, '+=0.15');
    }

    const correctSlide = document.getElementById('slide-correct');
    const correctObserver = new MutationObserver(() => {
      if (correctSlide.classList.contains('active')) {
        buildCorrectBars();
        setTimeout(animateCorrectBars, 400);
      }
    });
    correctObserver.observe(correctSlide, { attributes: true, attributeFilter: ['class'] });

    // ---- Emoji rain on title slide ----
    function initEmojiRain() {
      const container = document.getElementById('emoji-rain');
      const emojis = ['\u{1F954}', '\u{1F35F}', '\u{1F34B}', '\u{1F9C8}', '\u{1F525}', '\u{1F954}', '\u{1F35F}', '\u{1F954}'];
      const DROP_COUNT = 35;

      function spawnDrop() {
        const el = document.createElement('div');
        el.className = 'rain-drop';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        el.style.left = (Math.random() * 100) + '%';
        el.style.fontSize = (1.2 + Math.random() * 2) + 'rem';
        container.appendChild(el);

        const duration = 3 + Math.random() * 4;
        const wobble = -30 + Math.random() * 60;
        const spin = -180 + Math.random() * 360;

        gsap.to(el, {
          y: window.innerHeight + 80,
          x: wobble,
          rotation: spin,
          opacity: 0.15 + Math.random() * 0.25,
          duration: duration,
          ease: 'none',
          onComplete: () => {
            el.remove();
          }
        });
      }

      // Initial burst
      for (let i = 0; i < DROP_COUNT; i++) {
        gsap.delayedCall(Math.random() * 3, spawnDrop);
      }

      // Continuous rain
      setInterval(() => {
        if (document.getElementById('slide-title').classList.contains('active')) {
          spawnDrop();
        }
      }, 200);
    }

    // Start SSE connection
    connectSSE();

    // ---- Initialize ----
    progress.style.width = (1 / slides.length * 100) + '%';
    counter.textContent = '1 / ' + slides.length;
    animateFirstSlide(slides[0]);
    initEmojiRain();
  </script>
</body>
</html>
